version: '3.8'

services:
  breathable-commute:
    image: breathable-commute:latest
    container_name: breathable-commute-prod
    ports:
      - "8501:8501"
    environment:
      # Production environment variables
      - PYTHONUNBUFFERED=1
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
      
      # Indian city coordinates
      - NEW_DELHI_LAT=28.6139
      - NEW_DELHI_LON=77.2090
      - MUMBAI_LAT=19.0760
      - MUMBAI_LON=72.8777
      - BENGALURU_LAT=12.9716
      - BENGALURU_LON=77.5946
      - HYDERABAD_LAT=17.3850
      - HYDERABAD_LON=78.4867
      
      # Air quality thresholds (μg/m³)
      - HEALTHY_AIR_QUALITY_THRESHOLD=50.0
      - HAZARDOUS_AIR_QUALITY_THRESHOLD=100.0
      
      # Weather thresholds
      - MODERATE_WIND_THRESHOLD=20.0
      - HIGH_WIND_THRESHOLD=30.0
      - HIGH_TEMPERATURE_THRESHOLD=35.0
      - COMFORTABLE_TEMPERATURE_THRESHOLD=30.0
      
      # API configuration
      - OPEN_METEO_AIR_QUALITY_URL=https://air-quality-api.open-meteo.com/v1/air-quality
      - OPEN_METEO_WEATHER_URL=https://api.open-meteo.com/v1/forecast
      - REQUEST_TIMEOUT=15
      - MAX_RETRIES=5
      - RETRY_DELAY=2.0
      
      # Production performance settings
      - CACHE_DURATION_SECONDS=600
      - MAX_CONCURRENT_REQUESTS=20
      - CONNECTION_POOL_SIZE=50
      - PERFORMANCE_MONITORING_ENABLED=true
      - AUTO_REFRESH_INTERVAL=60
      - SLOW_REQUEST_THRESHOLD=3.0
      
      # Responsive design settings
      - MOBILE_BREAKPOINT=768
      - TABLET_BREAKPOINT=1024
      - CHART_HEIGHT_MOBILE=300
      - CHART_HEIGHT_TABLET=400
      - CHART_HEIGHT_DESKTOP=500
      
      # Production logging
      - LOG_LEVEL=WARNING
      - HEALTH_CHECK_ENABLED=true
      - HEALTH_CHECK_TIMEOUT=10
      
      # Application settings
      - APP_NAME=Breathable Commute
      - APP_VERSION=1.0.0
      
    restart: always
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8501/_stcore/health"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 120s
    networks:
      - breathable-commute-prod
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: breathable-commute-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-cache:/var/cache/nginx
    depends_on:
      - breathable-commute
    networks:
      - breathable-commute-prod
    restart: always
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

networks:
  breathable-commute-prod:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  nginx-cache:
    driver: local